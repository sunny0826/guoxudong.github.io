<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Guo Xudong's Blog·郭旭东的博客 – velero</title><link>https://guoxudong.io/tags/velero/</link><description>Recent content in velero on Guo Xudong's Blog·郭旭东的博客</description><generator>Hugo -- gohugo.io</generator><language>zh</language><lastBuildDate>Wed, 13 Nov 2019 09:13:22 +0800</lastBuildDate><atom:link href="https://guoxudong.io/tags/velero/index.xml" rel="self" type="application/rss+xml"/><item><title>Post: 使用 Velero 进行集群备份与迁移</title><link>https://guoxudong.io/post/aliyun-velero/</link><pubDate>Wed, 13 Nov 2019 09:13:22 +0800</pubDate><guid>https://guoxudong.io/post/aliyun-velero/</guid><description>
&lt;h2 id="前言">前言&lt;/h2>
&lt;p>在近日的一个风和日丽的下午，正在快乐的写 bug 时，突然间钉钉就被 call 爆了，原来是 k8s 测试集群的一个 namespace 突然不见了。这个 namespace 里面有 60 多个服务，瞬间全部没有了……虽然得益于我们的 CI/CD 系统，这些服务很快都重新部署并正常运行了，但是如果在生产环境，那后果就是不可想象的了。在排查这个问题发生的原因的同时，集群资源的灾备和恢复功能就提上日程了，这时 Velero 就出现了。&lt;/p>
&lt;h2 id="velero">Velero&lt;/h2>
&lt;p>&lt;a href="https://github.com/vmware-tanzu/velero">Velero&lt;/a> 是 VMWare 开源的 k8s 集群备份、迁移工具。可以帮助我们完成 k8s 的例行备份工作，以便在出现上面问题的时候可以快速进行恢复。同时也提供了集群迁移功能，可以将 k8s 资源迁移到其他 k8s 集群的功能。Velero 将集群资源保存在对象存储中，默认情况下可以使用 &lt;a href="https://velero.io/docs/v1.1.0/aws-config">AWS&lt;/a>、&lt;a href="https://velero.io/docs/v1.1.0/azure-config">Azure&lt;/a>、&lt;a href="https://velero.io/docs/v1.1.0/gcp-config">GCP&lt;/a> 的对象存储，同时也给出了插件功能用来拓展其他平台的存储，这里我们用到的就是阿里云的对象存储 OSS，阿里云也提供了 Velero 的插件，用于将备份存储到 OSS 中。下面我就介绍一下如何在阿里云容器服务 ACK 使用 Velero 完成备份和迁移。&lt;/p>
&lt;blockquote>
&lt;p>Velero 地址：https://github.com/vmware-tanzu/velero&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>ACK 插件地址：https://github.com/AliyunContainerService/velero-plugin&lt;/p>
&lt;/blockquote>
&lt;h3 id="下载-velero-客户端">下载 Velero 客户端&lt;/h3>
&lt;p>Velero 由客户端和服务端组成，服务器部署在目标 k8s 集群上，而客户端则是运行在本地的命令行工具。&lt;/p>
&lt;ul>
&lt;li>前往 &lt;a href="https://github.com/vmware-tanzu/velero/releases">Velero 的 Release 页面&lt;/a> 下载客户端，直接在 GitHub 上下载即可&lt;/li>
&lt;li>解压 release 包&lt;/li>
&lt;li>将 release 包中的二进制文件 &lt;code>velero&lt;/code> 移动到 &lt;code>$PATH&lt;/code> 中的某个目录下&lt;/li>
&lt;li>执行 &lt;code>velero -h&lt;/code> 测试&lt;/li>
&lt;/ul>
&lt;h3 id="创建-oss-bucket">创建 OSS bucket&lt;/h3>
&lt;p>创建一个 OSS bucket 用于存储备份文件，这里也可以用已有的 bucket，之后会在 bucket 中创建 &lt;code>backups&lt;/code>、&lt;code>metadata&lt;/code>、&lt;code>restores&lt;/code>三个目录，这里建议在已有的 bucket 中创建一个子目录用于存储备份文件。&lt;/p>
&lt;p>创建 OSS 的时候一定要选对区域，要和 ACK 集群在同一个区域，存储类型和读写权限选择&lt;strong>标准存储&lt;/strong>和&lt;strong>私有&lt;/strong>：&lt;/p>
&lt;p>&lt;img src="https://tva3.sinaimg.cn/wap720/ad5fbf65gy1g8w7t8c4xbj21021d8thq.jpg" alt="image">&lt;/p>
&lt;h3 id="创建阿里云-ram-用户">创建阿里云 RAM 用户&lt;/h3>
&lt;p>这里需要创建一个阿里云 RAM 的用户，用于操作 OSS 以及 ACK 资源。&lt;/p>
&lt;ul>
&lt;li>
&lt;p>新建权限策略&lt;/p>
&lt;p>&lt;img src="https://tvax4.sinaimg.cn/large/ad5fbf65gy1g8w80cjiv2j21uo18cag8.jpg" alt="image">&lt;/p>
&lt;p>策略内容：&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-json" data-lang="json">{
&lt;span style="color:#6ab825;font-weight:bold">&amp;#34;Version&amp;#34;&lt;/span>: &lt;span style="color:#ed9d13">&amp;#34;1&amp;#34;&lt;/span>,
&lt;span style="color:#6ab825;font-weight:bold">&amp;#34;Statement&amp;#34;&lt;/span>: [
{
&lt;span style="color:#6ab825;font-weight:bold">&amp;#34;Action&amp;#34;&lt;/span>: [
&lt;span style="color:#ed9d13">&amp;#34;ecs:DescribeSnapshots&amp;#34;&lt;/span>,
&lt;span style="color:#ed9d13">&amp;#34;ecs:CreateSnapshot&amp;#34;&lt;/span>,
&lt;span style="color:#ed9d13">&amp;#34;ecs:DeleteSnapshot&amp;#34;&lt;/span>,
&lt;span style="color:#ed9d13">&amp;#34;ecs:DescribeDisks&amp;#34;&lt;/span>,
&lt;span style="color:#ed9d13">&amp;#34;ecs:CreateDisk&amp;#34;&lt;/span>,
&lt;span style="color:#ed9d13">&amp;#34;ecs:Addtags&amp;#34;&lt;/span>,
&lt;span style="color:#ed9d13">&amp;#34;oss:PutObject&amp;#34;&lt;/span>,
&lt;span style="color:#ed9d13">&amp;#34;oss:GetObject&amp;#34;&lt;/span>,
&lt;span style="color:#ed9d13">&amp;#34;oss:DeleteObject&amp;#34;&lt;/span>,
&lt;span style="color:#ed9d13">&amp;#34;oss:GetBucket&amp;#34;&lt;/span>,
&lt;span style="color:#ed9d13">&amp;#34;oss:ListObjects&amp;#34;&lt;/span>
],
&lt;span style="color:#6ab825;font-weight:bold">&amp;#34;Resource&amp;#34;&lt;/span>: [
&lt;span style="color:#ed9d13">&amp;#34;*&amp;#34;&lt;/span>
],
&lt;span style="color:#6ab825;font-weight:bold">&amp;#34;Effect&amp;#34;&lt;/span>: &lt;span style="color:#ed9d13">&amp;#34;Allow&amp;#34;&lt;/span>
}
]
}
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>新建用户&lt;/p>
&lt;p>在新建用户的时候要选择 &lt;code>编程访问&lt;/code>，来获取 &lt;code>AccessKeyID&lt;/code> 和 &lt;code>AccessKeySecret&lt;/code>，这里请创建一个新用于用于备份，不要使用老用户的 AK 和 AS。&lt;/p>
&lt;p>&lt;img src="https://tvax2.sinaimg.cn/large/ad5fbf65gy1g8w8h4ek4uj21h40ue785.jpg" alt="image">&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h3 id="部署服务端">部署服务端&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>拉取 &lt;a href="https://github.com/AliyunContainerService/velero-plugin">Velero 插件&lt;/a> 到本地&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">git clone https://github.com/AliyunContainerService/velero-plugin
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>配置修改&lt;/p>
&lt;ol>
&lt;li>
&lt;p>修改 &lt;code>install/credentials-velero&lt;/code> 文件，将新建用户中获得的 &lt;code>AccessKeyID&lt;/code> 和 &lt;code>AccessKeySecret&lt;/code> 填入，这里的 OSS EndPoint 为之前 OSS 的访问域名（&lt;strong>注：这里需要选择外网访问的 EndPoint。&lt;/strong>）：&lt;/p>
&lt;p>&lt;img src="https://tvax2.sinaimg.cn/large/ad5fbf65gy1g8w8xd1sgzj21c20cm75z.jpg" alt="image">&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#40ffff">ALIBABA_CLOUD_ACCESS_KEY_ID&lt;/span>=&amp;lt;ALIBABA_CLOUD_ACCESS_KEY_ID&amp;gt;
&lt;span style="color:#40ffff">ALIBABA_CLOUD_ACCESS_KEY_SECRET&lt;/span>=&amp;lt;ALIBABA_CLOUD_ACCESS_KEY_SECRET&amp;gt;
&lt;span style="color:#40ffff">ALIBABA_CLOUD_OSS_ENDPOINT&lt;/span>=&amp;lt;ALIBABA_CLOUD_OSS_ENDPOINT&amp;gt;
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>修改 &lt;code>install/01-velero.yaml&lt;/code>，将 OSS 配置填入：&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="color:#447fcf;text-decoration:underline">---&lt;/span>&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666">&lt;/span>&lt;span style="color:#6ab825;font-weight:bold">apiVersion&lt;/span>:&lt;span style="color:#666"> &lt;/span>velero.io/v1&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666">&lt;/span>&lt;span style="color:#6ab825;font-weight:bold">kind&lt;/span>:&lt;span style="color:#666"> &lt;/span>BackupStorageLocation&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666">&lt;/span>&lt;span style="color:#6ab825;font-weight:bold">metadata&lt;/span>:&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666">&lt;/span>&lt;span style="color:#6ab825;font-weight:bold">labels&lt;/span>:&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">component&lt;/span>:&lt;span style="color:#666"> &lt;/span>velero&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666">&lt;/span>&lt;span style="color:#6ab825;font-weight:bold">name&lt;/span>:&lt;span style="color:#666"> &lt;/span>default&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666">&lt;/span>&lt;span style="color:#6ab825;font-weight:bold">namespace&lt;/span>:&lt;span style="color:#666"> &lt;/span>velero&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666">&lt;/span>&lt;span style="color:#6ab825;font-weight:bold">spec&lt;/span>:&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666">&lt;/span>&lt;span style="color:#6ab825;font-weight:bold">config&lt;/span>:&lt;span style="color:#666"> &lt;/span>{}&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666">&lt;/span>&lt;span style="color:#6ab825;font-weight:bold">objectStorage&lt;/span>:&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">bucket&lt;/span>:&lt;span style="color:#666"> &lt;/span>&amp;lt;ALIBABA_CLOUD_OSS_BUCKET&amp;gt; &lt;span style="color:#666"> &lt;/span>&lt;span style="color:#999;font-style:italic"># OSS bucket 名称&lt;/span>&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">prefix&lt;/span>:&lt;span style="color:#666"> &lt;/span>&amp;lt;OSS_PREFIX&amp;gt; &lt;span style="color:#666"> &lt;/span>&lt;span style="color:#999;font-style:italic"># bucket 子目录&lt;/span>&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666">&lt;/span>&lt;span style="color:#6ab825;font-weight:bold">provider&lt;/span>:&lt;span style="color:#666"> &lt;/span>alibabacloud&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666">&lt;/span>&lt;span style="color:#447fcf;text-decoration:underline">---&lt;/span>&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666">&lt;/span>&lt;span style="color:#6ab825;font-weight:bold">apiVersion&lt;/span>:&lt;span style="color:#666"> &lt;/span>velero.io/v1&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666">&lt;/span>&lt;span style="color:#6ab825;font-weight:bold">kind&lt;/span>:&lt;span style="color:#666"> &lt;/span>VolumeSnapshotLocation&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666">&lt;/span>&lt;span style="color:#6ab825;font-weight:bold">metadata&lt;/span>:&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666">&lt;/span>&lt;span style="color:#6ab825;font-weight:bold">labels&lt;/span>:&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">component&lt;/span>:&lt;span style="color:#666"> &lt;/span>velero&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666">&lt;/span>&lt;span style="color:#6ab825;font-weight:bold">name&lt;/span>:&lt;span style="color:#666"> &lt;/span>default&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666">&lt;/span>&lt;span style="color:#6ab825;font-weight:bold">namespace&lt;/span>:&lt;span style="color:#666"> &lt;/span>velero&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666">&lt;/span>&lt;span style="color:#6ab825;font-weight:bold">spec&lt;/span>:&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666">&lt;/span>&lt;span style="color:#6ab825;font-weight:bold">config&lt;/span>:&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">region&lt;/span>:&lt;span style="color:#666"> &lt;/span>&amp;lt;REGION&amp;gt; &lt;span style="color:#666"> &lt;/span>&lt;span style="color:#999;font-style:italic"># 地域，如果是华东2（上海），则为 cn-shanghai&lt;/span>&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666">&lt;/span>&lt;span style="color:#6ab825;font-weight:bold">provider&lt;/span>:&lt;span style="color:#666"> &lt;/span>alibabacloud&lt;span style="color:#666">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>k8s 部署 Velero 服务&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#999;font-style:italic"># 新建 namespace&lt;/span>
kubectl create namespace velero
&lt;span style="color:#999;font-style:italic"># 部署 credentials-velero 的 secret&lt;/span>
kubectl create secret generic cloud-credentials --namespace velero --from-file &lt;span style="color:#40ffff">cloud&lt;/span>=install/credentials-velero
&lt;span style="color:#999;font-style:italic"># 部署 CRD&lt;/span>
kubectl apply -f install/00-crds.yaml
&lt;span style="color:#999;font-style:italic"># 部署 Velero&lt;/span>
kubectl apply -f install/01-velero.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>测试 Velero 状态&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ velero version
Client:
Version: v1.1.0
Git commit: a357f21aec6b39a8244dd23e469cc4519f1fe608
Server:
Version: v1.1.0
&lt;/code>&lt;/pre>&lt;/div>&lt;p>可以看到 Velero 的客户端和服务端已经部署成功。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>服务端清理&lt;/p>
&lt;p>在完成测试或者需要重新安装时，执行如下命令进行清理：&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">kubectl delete namespace/velero clusterrolebinding/velero
kubectl delete crds -l &lt;span style="color:#40ffff">component&lt;/span>=velero
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;/li>
&lt;/ul>
&lt;h3 id="备份测试">备份测试&lt;/h3>
&lt;p>&lt;code>velero-plugin&lt;/code> 项目中已经给出 &lt;code>example&lt;/code> 用于测试备份。&lt;/p>
&lt;ul>
&lt;li>部署测试服务&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">kubectl apply -f examples/base.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>对 &lt;code>nginx-example&lt;/code> 所在的 namespace 进行备份&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">velero backup create nginx-backup --include-namespaces nginx-example --wait
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>模拟 namespace 被误删&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">kubectl delete namespaces nginx-example
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>使用 Velero 进行恢复&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">velero restore create --from-backup nginx-backup --wait
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="集群迁移">集群迁移&lt;/h3>
&lt;p>迁移方法同备份，在备份后切换集群，在新集群恢复备份即可。&lt;/p>
&lt;h3 id="高级用法">高级用法&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>定时备份&lt;/p>
&lt;p>对集群资源进行定时备份，则可在发生意外的情况下，进行恢复（默认情况下，备份保留 30 天）。&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#999;font-style:italic"># 每日1点进行备份&lt;/span>
velero create schedule &amp;lt;SCHEDULE NAME&amp;gt; --schedule=&lt;span style="color:#ed9d13">&amp;#34;0 1 * * *&amp;#34;&lt;/span>
&lt;span style="color:#999;font-style:italic"># 每日1点进行备份，备份保留48小时&lt;/span>
velero create schedule &amp;lt;SCHEDULE NAME&amp;gt; --schedule=&lt;span style="color:#ed9d13">&amp;#34;0 1 * * *&amp;#34;&lt;/span> --ttl 48h
&lt;span style="color:#999;font-style:italic"># 每6小时进行一次备份&lt;/span>
velero create schedule &amp;lt;SCHEDULE NAME&amp;gt; --schedule=&lt;span style="color:#ed9d13">&amp;#34;@every 6h&amp;#34;&lt;/span>
&lt;span style="color:#999;font-style:italic"># 每日对 web namespace 进行一次备份&lt;/span>
velero create schedule &amp;lt;SCHEDULE NAME&amp;gt; --schedule=&lt;span style="color:#ed9d13">&amp;#34;@every 24h&amp;#34;&lt;/span> --include-namespaces web
&lt;/code>&lt;/pre>&lt;/div>&lt;p>定时备份的名称为：&lt;code>&amp;lt;SCHEDULE NAME&amp;gt;-&amp;lt;TIMESTAMP&amp;gt;&lt;/code>，恢复命令为：&lt;code>velero restore create --from-backup &amp;lt;SCHEDULE NAME&amp;gt;-&amp;lt;TIMESTAMP&amp;gt;&lt;/code>。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>备份删除&lt;/p>
&lt;p>直接执行命令进行删除&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">velero delete backups &amp;lt;BACKUP_NAME&amp;gt;
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>备份资源查看&lt;/p>
&lt;p>备份查看&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">velero backup get
&lt;/code>&lt;/pre>&lt;/div>&lt;p>查看定时备份&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">velero schedule get
&lt;/code>&lt;/pre>&lt;/div>&lt;p>查看可恢复备份&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">velero restore get
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>备份排除项目&lt;/p>
&lt;p>可为资源添加指定标签，添加标签的资源在备份的时候被排除。&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#999;font-style:italic"># 添加标签&lt;/span>
kubectl label -n &amp;lt;ITEM_NAMESPACE&amp;gt; &amp;lt;RESOURCE&amp;gt;/&amp;lt;NAME&amp;gt; velero.io/exclude-from-backup=&lt;span style="color:#24909d">true&lt;/span>
&lt;span style="color:#999;font-style:italic"># 为 default namespace 添加标签&lt;/span>
kubectl label -n default namespace/default velero.io/exclude-from-backup=&lt;span style="color:#24909d">true&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;h3 id="问题汇总">问题汇总&lt;/h3>
&lt;h4 id="时区问题">时区问题&lt;/h4>
&lt;p>进行定时备份时，发现备份使用的事 UTC 时间，并不是本地时间，经过排查后发现是 &lt;code>velero&lt;/code> 镜像的时区问题，在调整后就会正常定时备份了，这里我重新调整了时区，直接调整镜像就好，修改 &lt;code>install/01-velero.yaml&lt;/code> 文件，将镜像替换为 &lt;code>registry-vpc.cn-shanghai.aliyuncs.com/keking/velero:latest&lt;/code>。&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="color:#6ab825;font-weight:bold">image&lt;/span>:&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">caption&lt;/span>:&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#ed9d13">&amp;#34;Image from: [**Pexels**](https://www.pexels.com)&amp;#34;&lt;/span>&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">focal_point&lt;/span>:&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#ed9d13">&amp;#34;&amp;#34;&lt;/span>&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">preview_only&lt;/span>:&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">false&lt;/span>&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666">&lt;/span>&lt;span style="color:#447fcf;text-decoration:underline">---&lt;/span>&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666">&lt;/span>&lt;span style="color:#6ab825;font-weight:bold">apiVersion&lt;/span>:&lt;span style="color:#666"> &lt;/span>extensions/v1beta1&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666">&lt;/span>&lt;span style="color:#6ab825;font-weight:bold">kind&lt;/span>:&lt;span style="color:#666"> &lt;/span>Deployment&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666">&lt;/span>&lt;span style="color:#6ab825;font-weight:bold">metadata&lt;/span>:&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">name&lt;/span>:&lt;span style="color:#666"> &lt;/span>velero&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">namespace&lt;/span>:&lt;span style="color:#666"> &lt;/span>velero&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666">&lt;/span>&lt;span style="color:#6ab825;font-weight:bold">spec&lt;/span>:&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">replicas&lt;/span>:&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#3677a9">1&lt;/span>&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">selector&lt;/span>:&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">matchLabels&lt;/span>:&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">deploy&lt;/span>:&lt;span style="color:#666"> &lt;/span>velero&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">template&lt;/span>:&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">metadata&lt;/span>:&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">annotations&lt;/span>:&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">prometheus.io/path&lt;/span>:&lt;span style="color:#666"> &lt;/span>/metrics&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">prometheus.io/port&lt;/span>:&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#ed9d13">&amp;#34;8085&amp;#34;&lt;/span>&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">prometheus.io/scrape&lt;/span>:&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#ed9d13">&amp;#34;true&amp;#34;&lt;/span>&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">labels&lt;/span>:&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">component&lt;/span>:&lt;span style="color:#666"> &lt;/span>velero&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">deploy&lt;/span>:&lt;span style="color:#666"> &lt;/span>velero&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">spec&lt;/span>:&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">serviceAccountName&lt;/span>:&lt;span style="color:#666"> &lt;/span>velero&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">containers&lt;/span>:&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>- &lt;span style="color:#6ab825;font-weight:bold">name&lt;/span>:&lt;span style="color:#666"> &lt;/span>velero&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#999;font-style:italic"># sync from gcr.io/heptio-images/velero:latest&lt;/span>&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">image&lt;/span>:&lt;span style="color:#666"> &lt;/span>registry-vpc.cn-shanghai.aliyuncs.com/keking/velero:latest &lt;span style="color:#666"> &lt;/span>&lt;span style="color:#999;font-style:italic"># 修复时区后的镜像&lt;/span>&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">imagePullPolicy&lt;/span>:&lt;span style="color:#666"> &lt;/span>IfNotPresent&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">command&lt;/span>:&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>- /velero&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">args&lt;/span>:&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>- server&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>- --default-volume-snapshot-locations=alibabacloud:default&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">env&lt;/span>:&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>- &lt;span style="color:#6ab825;font-weight:bold">name&lt;/span>:&lt;span style="color:#666"> &lt;/span>VELERO_SCRATCH_DIR&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">value&lt;/span>:&lt;span style="color:#666"> &lt;/span>/scratch&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>- &lt;span style="color:#6ab825;font-weight:bold">name&lt;/span>:&lt;span style="color:#666"> &lt;/span>ALIBABA_CLOUD_CREDENTIALS_FILE&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">value&lt;/span>:&lt;span style="color:#666"> &lt;/span>/credentials/cloud&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">volumeMounts&lt;/span>:&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>- &lt;span style="color:#6ab825;font-weight:bold">mountPath&lt;/span>:&lt;span style="color:#666"> &lt;/span>/plugins&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">name&lt;/span>:&lt;span style="color:#666"> &lt;/span>plugins&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>- &lt;span style="color:#6ab825;font-weight:bold">mountPath&lt;/span>:&lt;span style="color:#666"> &lt;/span>/scratch&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">name&lt;/span>:&lt;span style="color:#666"> &lt;/span>scratch&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>- &lt;span style="color:#6ab825;font-weight:bold">mountPath&lt;/span>:&lt;span style="color:#666"> &lt;/span>/credentials&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">name&lt;/span>:&lt;span style="color:#666"> &lt;/span>cloud-credentials&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">initContainers&lt;/span>:&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>- &lt;span style="color:#6ab825;font-weight:bold">image&lt;/span>:&lt;span style="color:#666"> &lt;/span>registry.cn-hangzhou.aliyuncs.com/acs/velero-plugin-alibabacloud:v1.2&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">imagePullPolicy&lt;/span>:&lt;span style="color:#666"> &lt;/span>IfNotPresent&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">name&lt;/span>:&lt;span style="color:#666"> &lt;/span>velero-plugin-alibabacloud&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">volumeMounts&lt;/span>:&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>- &lt;span style="color:#6ab825;font-weight:bold">mountPath&lt;/span>:&lt;span style="color:#666"> &lt;/span>/target&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">name&lt;/span>:&lt;span style="color:#666"> &lt;/span>plugins&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">volumes&lt;/span>:&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>- &lt;span style="color:#6ab825;font-weight:bold">emptyDir&lt;/span>:&lt;span style="color:#666"> &lt;/span>{}&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">name&lt;/span>:&lt;span style="color:#666"> &lt;/span>plugins&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>- &lt;span style="color:#6ab825;font-weight:bold">emptyDir&lt;/span>:&lt;span style="color:#666"> &lt;/span>{}&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">name&lt;/span>:&lt;span style="color:#666"> &lt;/span>scratch&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>- &lt;span style="color:#6ab825;font-weight:bold">name&lt;/span>:&lt;span style="color:#666"> &lt;/span>cloud-credentials&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">secret&lt;/span>:&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666"> &lt;/span>&lt;span style="color:#6ab825;font-weight:bold">secretName&lt;/span>:&lt;span style="color:#666"> &lt;/span>cloud-credentials&lt;span style="color:#666">
&lt;/span>&lt;span style="color:#666">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="版本问题">版本问题&lt;/h4>
&lt;p>截止发稿时，Velero 已经发布了 v1.2.0 版本，目前 ACK 的 Velero 的插件还未升级。&lt;/p>
&lt;h2 id="结语">结语&lt;/h2>
&lt;p>近日正好有 k8s 集群服务迁移服务的需求，使用 Velero 完成了服务的迁移，同时也每日进行集群资源备份，其能力可以满足容器服务的灾备和迁移场景，实测可用，现已运行在所有的 k8s 集群。&lt;/p></description></item></channel></rss>