<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Guo Xudong&#39;s Blog·郭旭东的博客 – Kubernetes Plugin</title>
    <link>https://guoxudong.io/categories/kubernetes-plugin/</link>
    <description>Recent content in Kubernetes Plugin on Guo Xudong&#39;s Blog·郭旭东的博客</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>zh</language>
    <lastBuildDate>Fri, 15 Jan 2021 15:34:10 +0800</lastBuildDate>
    
	  <atom:link href="https://guoxudong.io/categories/kubernetes-plugin/index.xml" rel="self" type="application/rss+xml" />
    
    
      
        
      
    
    
    <item>
      <title>Post: 使用 kubectl-rabbitmq 部署和运维 K8S 上的 RabbitMQ 集群</title>
      <link>https://guoxudong.io/post/kubectl-rabbitmq/</link>
      <pubDate>Fri, 15 Jan 2021 15:34:10 +0800</pubDate>
      
      <guid>https://guoxudong.io/post/kubectl-rabbitmq/</guid>
      <description>
        
        
        &lt;h2 id=&#34;前言&#34;&gt;前言&lt;/h2&gt;
&lt;p&gt;最近接到一个在 K8S 中部署一个 RabbitMQ 集群的任务，既然是部署在 K8S 集群中，首选的当然是 RabbitMQ Operator 了。不过在浏览官方文档时，意外的官方也有开发一个 kubectl-rabbitmq 的插件来帮助部署和运维 RabbitMQ Operator，在试用后发现体验意外的不错。那么本文我们就使用 kubectl-rabbitmq 来部署一个 RabbitMQ 集群吧！&lt;/p&gt;
&lt;h2 id=&#34;插件安装&#34;&gt;插件安装&lt;/h2&gt;
&lt;p&gt;安装插件前需要安装 &lt;a href=&#34;https://krew.sigs.k8s.io/&#34;&gt;krew&lt;/a&gt;，也就是 kubectl 的插件管理工具，krew 的安装这里就不做详细说明了。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&amp;amp; kubectl krew install rabbitmq
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;安装完成后就可以使用 &lt;code&gt;kubectl rabbitmq&lt;/code&gt; 来部署和管理 RabbitMQ 集群了。&lt;/p&gt;
&lt;h3 id=&#34;安装-rabbitmq-operator&#34;&gt;安装 RabbitMQ Operator&lt;/h3&gt;
&lt;p&gt;使用 &lt;code&gt;kubectl-rabbitmq&lt;/code&gt; 安装 RabbitMQ Operator 非常简单，只需一行命令：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;$ kubectl rabbitmq install-cluster-operator
namespace/rabbitmq-system created
customresourcedefinition.apiextensions.k8s.io/rabbitmqclusters.rabbitmq.com created
serviceaccount/rabbitmq-cluster-operator created
role.rbac.authorization.k8s.io/rabbitmq-cluster-leader-election-role created
clusterrole.rbac.authorization.k8s.io/rabbitmq-cluster-operator-role created
rolebinding.rbac.authorization.k8s.io/rabbitmq-cluster-leader-election-rolebinding created
clusterrolebinding.rbac.authorization.k8s.io/rabbitmq-cluster-operator-rolebinding created
deployment.apps/rabbitmq-cluster-operator created
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;之后就可以看到 &lt;code&gt;rabbitmq-cluster-operator&lt;/code&gt; 已经不再在 namespace： &lt;code&gt;rabbitmq-system&lt;/code&gt; 中了：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;$ kubectl get pod -n rabbitmq-system
NAME                                         READY   STATUS    RESTARTS   AGE
rabbitmq-cluster-operator-7bbbb8d559-k8zwm   1/1     Running   &lt;span style=&#34;color:#3677a9&#34;&gt;0&lt;/span&gt;          35m
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;创建-rabbitmq-集群&#34;&gt;创建 RabbitMQ 集群&lt;/h3&gt;
&lt;p&gt;创建 RabbitMQ 集群同样简单，也是一行命令：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;$ kubectl rabbitmq create &amp;lt;rabbitmq-cluster-name&amp;gt; --replicas &lt;span style=&#34;color:#3677a9&#34;&gt;1&lt;/span&gt; --service ClusterIP --image rabbitmq:3.8.9-management
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;这里除了 &lt;code&gt;&amp;lt;rabbitmq-cluster-name&amp;gt;&lt;/code&gt; 以外，其余参数均为可选项，内容为 RabbitMQ Operator 的 CR 文件。此处的原理也比较简单，只是生成了一份 CR 配置。更多参数请参考&lt;a href=&#34;https://www.rabbitmq.com/kubernetes/operator/using-operator.html&#34;&gt;官方文档&lt;/a&gt;。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;$ kubectl get RabbitmqCluster
NAME            AGE   STATUS
test-rabbitmq   54s
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;div class=&#34;alert alert-warning&#34; role=&#34;alert&#34;&gt;
&lt;h4 class=&#34;alert-heading&#34;&gt;注意&lt;/h4&gt;
请确保你集群有可用的 &lt;code&gt;StorageClass&lt;/code&gt;，因为默认情况下 RabbitMQ Operator 创建的 RabbitMQ 集群会为每个实例使用 &lt;code&gt;StorageClass&lt;/code&gt; 分配一个 10G 的 PVC
&lt;/div&gt;

&lt;h3 id=&#34;查看集群中所有-rabbitmq&#34;&gt;查看集群中所有 RabbitMQ&lt;/h3&gt;
&lt;p&gt;可以使用 &lt;code&gt;list&lt;/code&gt; 命令查看集群中所有使用 RabbitMQ Operator 创建的 RabbitMQ 集群：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;$ kubectl rabbitmq list
NAME            AGE   STATUS
test-rabbitmq   10m
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;查看指定-rabbitmq-的所有资源&#34;&gt;查看指定 RabbitMQ 的所有资源&lt;/h3&gt;
&lt;p&gt;使用 &lt;code&gt;get&lt;/code&gt; 命令可以轻松查看指定 RabbitMQ 集群的全部资源：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;$ kubectl rabbitmq get test-rabbitmq
NAME                         READY   STATUS    RESTARTS   AGE
pod/test-rabbitmq-server-0   1/1     Running   &lt;span style=&#34;color:#3677a9&#34;&gt;0&lt;/span&gt;          11m

NAME                                   DATA   AGE
configmap/test-rabbitmq-plugins-conf   &lt;span style=&#34;color:#3677a9&#34;&gt;1&lt;/span&gt;      11m
configmap/test-rabbitmq-server-conf    &lt;span style=&#34;color:#3677a9&#34;&gt;2&lt;/span&gt;      11m

NAME                                    READY   AGE
statefulset.apps/test-rabbitmq-server   1/1     11m

NAME                          TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)              AGE
service/test-rabbitmq         ClusterIP   10.96.84.122   &amp;lt;none&amp;gt;        15672/TCP,5672/TCP   11m
service/test-rabbitmq-nodes   ClusterIP   None           &amp;lt;none&amp;gt;        4369/TCP,25672/TCP   11m

NAME                                 TYPE     DATA   AGE
secret/test-rabbitmq-default-user    Opaque   &lt;span style=&#34;color:#3677a9&#34;&gt;3&lt;/span&gt;      11m
secret/test-rabbitmq-erlang-cookie   Opaque   &lt;span style=&#34;color:#3677a9&#34;&gt;1&lt;/span&gt;      11m
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;打开-rabbitmq-ui&#34;&gt;打开 RabbitMQ UI&lt;/h3&gt;
&lt;p&gt;一般情况下，我们访问 ClusterIP 类型的 svc 都要使用到 &lt;code&gt;pord-forward&lt;/code&gt; 的方式，&lt;code&gt;kubectl-rabbitmq&lt;/code&gt; 则封装了该方法，使用 &lt;code&gt;manage&lt;/code&gt; 命令即可马上弹出 UI 界面：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;$ kubectl rabbitmq manage test-rabbitmq
Forwarding from 127.0.0.1:15672 -&amp;gt; &lt;span style=&#34;color:#3677a9&#34;&gt;15672&lt;/span&gt;
Forwarding from [::1]:15672 -&amp;gt; &lt;span style=&#34;color:#3677a9&#34;&gt;15672&lt;/span&gt;
Handling connection &lt;span style=&#34;color:#6ab825;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#3677a9&#34;&gt;15672&lt;/span&gt;
Handling connection &lt;span style=&#34;color:#6ab825;font-weight:bold&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#3677a9&#34;&gt;15672&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;获取默认用户&#34;&gt;获取默认用户&lt;/h3&gt;
&lt;p&gt;既然已经可以访问 UI 界面了，那么下一步肯定是获取默认用户名/密码，使用 &lt;code&gt;secrets&lt;/code&gt; 命令即可：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;$ kubectl rabbitmq secrets test-rabbitmq
username: sLSVWbiixZSB_XKL6SoI9kB_Pdefe477
password: zm0oV3UraiadH9E2NNot6Igq8woeEyRi
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;当然也可以直接查看 &lt;code&gt;secrets&lt;/code&gt; 资源：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;color:#999;font-style:italic&#34;&gt;# user&lt;/span&gt;
kubectl -n NAMESPACE get secret INSTANCE-default-user -o &lt;span style=&#34;color:#40ffff&#34;&gt;jsonpath&lt;/span&gt;=&lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;{.data.username}&amp;#34;&lt;/span&gt; | base64 --decode
&lt;span style=&#34;color:#999;font-style:italic&#34;&gt;# pass&lt;/span&gt;
kubectl -n NAMESPACE get secret INSTANCE-default-user -o &lt;span style=&#34;color:#40ffff&#34;&gt;jsonpath&lt;/span&gt;=&lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;{.data.password}&amp;#34;&lt;/span&gt; | base64 --decode
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;现在就顺利登陆 UI 界面了&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://tvax3.sinaimg.cn/large/ad5fbf65gy1gmoh3scl4pj23ra1aidox.jpg&#34; alt=&#34;RabbitMQ UI&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;监控-rabbitmq&#34;&gt;监控 RabbitMQ&lt;/h3&gt;
&lt;p&gt;使用 &lt;code&gt;observe&lt;/code&gt; 可以在终端观察指定 RabbitMQ 节点的监控信息，如下命令是查看 &lt;code&gt;test-rabbitmq-server-0&lt;/code&gt; 的监控信息：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;$ kubectl rabbitmq observe test-rabbitmq &lt;span style=&#34;color:#3677a9&#34;&gt;0&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;https://tvax4.sinaimg.cn/large/ad5fbf65gy1gmoh8s8qe0j21rc1a87lq.jpg&#34; alt=&#34;image&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;验证-rabbitmq&#34;&gt;验证 RabbitMQ&lt;/h3&gt;
&lt;p&gt;为了验证 RabbitMQ 是否正常运行，使用 &lt;code&gt;perf-test&lt;/code&gt; 来进行：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;$ kubectl rabbitmq perf-test test-rabbitmq --rate &lt;span style=&#34;color:#3677a9&#34;&gt;100&lt;/span&gt;
service/perf-test created
pod/perf-test created
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;这里可以看到拉起了 &lt;code&gt;perf-test&lt;/code&gt; 的 pod 和 svc，查看其日志：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;$ kubectl logs -f perf-test
id: test-091555-328, starting consumer &lt;span style=&#34;color:#999;font-style:italic&#34;&gt;#0&lt;/span&gt;
id: test-091555-328, starting consumer &lt;span style=&#34;color:#999;font-style:italic&#34;&gt;#0, channel #0&lt;/span&gt;
id: test-091555-328, starting producer &lt;span style=&#34;color:#999;font-style:italic&#34;&gt;#0&lt;/span&gt;
id: test-091555-328, starting producer &lt;span style=&#34;color:#999;font-style:italic&#34;&gt;#0, channel #0&lt;/span&gt;
id: test-091555-328, time: 1.000s, sent: &lt;span style=&#34;color:#3677a9&#34;&gt;15259&lt;/span&gt; msg/s, received: &lt;span style=&#34;color:#3677a9&#34;&gt;9462&lt;/span&gt; msg/s, min/median/75th/95th/99th consumer latency: 5337/140173/167205/239702/259102 µs
id: test-091555-328, time: 2.000s, sent: &lt;span style=&#34;color:#3677a9&#34;&gt;44288&lt;/span&gt; msg/s, received: &lt;span style=&#34;color:#3677a9&#34;&gt;13328&lt;/span&gt; msg/s, min/median/75th/95th/99th consumer latency: 281875/625383/726050/825489/844442 µs
id: test-091555-328, time: 3.000s, sent: &lt;span style=&#34;color:#3677a9&#34;&gt;35377&lt;/span&gt; msg/s, received: &lt;span style=&#34;color:#3677a9&#34;&gt;16624&lt;/span&gt; msg/s, min/median/75th/95th/99th consumer latency: 869436/1176394/1463207/1500775/1509740 µs
id: test-091555-328, time: 4.001s, sent: &lt;span style=&#34;color:#3677a9&#34;&gt;15490&lt;/span&gt; msg/s, received: &lt;span style=&#34;color:#3677a9&#34;&gt;21770&lt;/span&gt; msg/s, min/median/75th/95th/99th consumer latency: 1404599/1549405/1735201/1917333/1953431 µs
id: test-091555-328, time: 5.001s, sent: &lt;span style=&#34;color:#3677a9&#34;&gt;17367&lt;/span&gt; msg/s, received: &lt;span style=&#34;color:#3677a9&#34;&gt;18243&lt;/span&gt; msg/s, min/median/75th/95th/99th consumer latency: 1967969/2297884/2502092/2649344/2678139 µs
id: test-091555-328, time: 6.005s, sent: &lt;span style=&#34;color:#3677a9&#34;&gt;16679&lt;/span&gt; msg/s, received: &lt;span style=&#34;color:#3677a9&#34;&gt;17953&lt;/span&gt; msg/s, min/median/75th/95th/99th consumer latency: 2484404/2998748/3165893/3294687/3326600 µs
id: test-091555-328, time: 7.006s, sent: &lt;span style=&#34;color:#3677a9&#34;&gt;16729&lt;/span&gt; msg/s, received: &lt;span style=&#34;color:#3677a9&#34;&gt;18375&lt;/span&gt; msg/s, min/median/75th/95th/99th consumer latency: 2393535/2753560/2990014/3194592/3224623 µs
id: test-091555-328, time: 8.006s, sent: &lt;span style=&#34;color:#3677a9&#34;&gt;20648&lt;/span&gt; msg/s, received: &lt;span style=&#34;color:#3677a9&#34;&gt;17156&lt;/span&gt; msg/s, min/median/75th/95th/99th consumer latency: 2472263/2861278/3079786/3256128/3313167 µs

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;在 UI 上也可以看到监控发生了变化。&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://tvax3.sinaimg.cn/large/ad5fbf65gy1gmohfwtciuj23p21g8qfb.jpg&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;验证完成后删除 &lt;code&gt;perf-test&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;$ kubectl delete pod,svc perf-test
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;删除-rabbitmq-集群&#34;&gt;删除 RabbitMQ 集群&lt;/h3&gt;
&lt;p&gt;完成测试后，使用 &lt;code&gt;delete&lt;/code&gt; 即可删除 RabbitMQ 集群。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;$ kubectl rabbitmq delete test-rabbitmq
rabbitmqcluster.rabbitmq.com &lt;span style=&#34;color:#ed9d13&#34;&gt;&amp;#34;test-rabbitmq&amp;#34;&lt;/span&gt; deleted
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;总结&#34;&gt;总结&lt;/h2&gt;
&lt;p&gt;以上的这些功能，使用 &lt;code&gt;kubectl&lt;/code&gt; 和 yaml 文件也可以完成同样的效果，只不过有些操作比较繁琐。&lt;code&gt;kubectl rabbitmq&lt;/code&gt; 简化了很多操作，在实际管理和维护 RabbitMQ 集群时，是一个非常不错的工具。&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Post: K8S 资源可视化利器：Kubectl-Graph</title>
      <link>https://guoxudong.io/post/kubectl-graph/</link>
      <pubDate>Tue, 29 Dec 2020 10:19:18 +0800</pubDate>
      
      <guid>https://guoxudong.io/post/kubectl-graph/</guid>
      <description>
        
        
        &lt;h2 id=&#34;前言&#34;&gt;前言&lt;/h2&gt;
&lt;p&gt;最近接手了一个规模比较大的集群，光是整理集群中的资源就使人头昏眼花，虽然我自认 &lt;code&gt;kubectl&lt;/code&gt; 使用的已经十分熟练，但是上千个 kubernetes resource 看下来还是不堪重负。在不能为集群安装任何其他工具的情况下，可以改造的就只有我自己的 client 端，也就是 &lt;code&gt;kubectl&lt;/code&gt; 了。本文就介绍一个有趣的 kubectl 插件：&lt;code&gt;kubectl-graph&lt;/code&gt;。&lt;/p&gt;
&lt;h2 id=&#34;krew&#34;&gt;krew&lt;/h2&gt;
&lt;p&gt;要介绍 kubectl 的 plugin 机制，首先要介绍的就是 &lt;a href=&#34;https://krew.sigs.k8s.io/&#34;&gt;krew&lt;/a&gt; 。 krew 是 kubernetes &lt;a href=&#34;https://github.com/kubernetes/community/blob/master/sig-cli/README.md#cli-special-interest-group&#34;&gt;CLI SIG&lt;/a&gt; 项目，是用来管理 kubectl 插件的工具，作用类似于 yum 和 brew，可以用来搜索、安装和管理 kubectl 插件。&lt;/p&gt;
&lt;h2 id=&#34;kubectl-graph&#34;&gt;kubectl-graph&lt;/h2&gt;
&lt;p&gt;kubectl-graph 是一款可视化 kubernetes resource 及资源间关系的 kubectl 插件，可以将集群中的资源以关系图的方式进行展示。&lt;/p&gt;
&lt;p&gt;目前支持两种展示方法：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://graphviz.org/&#34;&gt;Graphviz&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://neo4j.com/&#34;&gt;Neo4j&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;前期准备&#34;&gt;前期准备&lt;/h2&gt;
&lt;p&gt;除了 &lt;code&gt;kubectl&lt;/code&gt;，由于需要进行绘图，所以还需安装上面两种展示方式的依赖。&lt;/p&gt;
&lt;h3 id=&#34;graphviz&#34;&gt;Graphviz&lt;/h3&gt;
&lt;p&gt;安装 Graphviz 用来生成关系图，需要使用 &lt;code&gt;dot&lt;/code&gt; CLI 工具，并将图像输出为 SVG 格式：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ brew install graphviz
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;neo4j&#34;&gt;Neo4j&lt;/h3&gt;
&lt;p&gt;Neo4j 是一个高性能的 NoSQL 图形数据库，它将结构化数据存储在网络上而不是表中，很适合用来展示 kubernetes resource 之间的关系，但 Neo4j 的依赖较多，需要一点时间来安装。&lt;/p&gt;
&lt;h4 id=&#34;安装-java&#34;&gt;安装 Java&lt;/h4&gt;
&lt;p&gt;Neo4j 依赖 Java 环境，如果本机上没有安装 Java，请先前往 &lt;a href=&#34;http://www.java.com&#34;&gt;http://www.java.com&lt;/a&gt; 下载并安装。&lt;/p&gt;
&lt;h4 id=&#34;安装-cypher-shell&#34;&gt;安装 cypher-shell&lt;/h4&gt;
&lt;p&gt;因为需要连接到 Neo4j 数据库，所以要安装 &lt;code&gt;cypher-shell&lt;/code&gt; CLI：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ brew install cypher-shell
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;安装-neo4j-desktop可选&#34;&gt;安装 Neo4j Desktop（可选）&lt;/h4&gt;
&lt;p&gt;接下来就是 Neo4j 本身的安装，我这里使用了 &lt;code&gt;Neo4j Desktop&lt;/code&gt;，使用和管理起来比较方便，也是使用 &lt;code&gt;brew&lt;/code&gt; 安装：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ brew install --cask neo4j
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;安装好后，运行 &lt;code&gt;Neo4j Desktop&lt;/code&gt;，完成设置即可&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://tva4.sinaimg.cn/large/ad5fbf65gy1gm4ngqfkvzj21z41kwgqi.jpg&#34; alt=&#34;设置 neo4j&#34;&gt;&lt;/p&gt;
&lt;h4 id=&#34;使用-docker-运行-neo4j可选&#34;&gt;使用 docker 运行 Neo4j（可选）&lt;/h4&gt;
&lt;p&gt;当然，如果你感觉安装 &lt;code&gt;Neo4j Desktop&lt;/code&gt; 比较麻烦，也可以使用 docker 运行 Neo4j：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ docker run --rm -p 7474:7474 -p 7687:7687 -e &lt;span style=&#34;color:#40ffff&#34;&gt;NEO4J_AUTH&lt;/span&gt;=none neo4j
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;只不过后续查看关系图时，需要使用浏览器访问 http://localhost:7474 来查看结果。&lt;/p&gt;
&lt;h3 id=&#34;安装-kubectl-graph&#34;&gt;安装 kubectl-graph&lt;/h3&gt;
&lt;p&gt;插件的安装方式比较简单，如果你使用的是 &lt;code&gt;kubectl 1.19&lt;/code&gt; 之前的版本：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ kubectl-krew install graph
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;使用 &lt;code&gt;kubectl 1.19&lt;/code&gt; 之后的版本：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ kubectl krew install graph
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;使用方式&#34;&gt;使用方式&lt;/h2&gt;
&lt;p&gt;安装完成后，就可以开始绘制 kubernetes resource 关系图了。&lt;/p&gt;
&lt;h3 id=&#34;graphviz-1&#34;&gt;Graphviz&lt;/h3&gt;
&lt;p&gt;使用 &lt;code&gt;kubectl graph&lt;/code&gt; 命令获取 &lt;code&gt;kubec-system&lt;/code&gt; 中正在运行的 pod，并通过管道传递给 &lt;code&gt;dot&lt;/code&gt;：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ kubectl graph pods --field-selector status.phase=Running -n kube-system | dot -T svg -o pods.svg
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;查看 &lt;code&gt;pods.svg&lt;/code&gt; ，资源果然很多：&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://tva1.sinaimg.cn/large/ad5fbf65gy1gm4nxnytzkj22d41zq19w.jpg&#34; alt=&#34;pods.svg&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;neo4j-1&#34;&gt;Neo4j&lt;/h3&gt;
&lt;p&gt;Neo4j 可以展示更为丰富且美观的关系图。在导入 kubernetes resource 之前，需要创建一个 Neo4j 数据库：&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://tvax1.sinaimg.cn/large/ad5fbf65gy1gm4o4b56mzj21z41kw46d.jpg&#34; alt=&#34;创建 neo4j 数据库&#34;&gt;&lt;/p&gt;
&lt;p&gt;数据库创建好后，点击 &lt;code&gt;Start&lt;/code&gt; 运行并点击 &lt;code&gt;Open&lt;/code&gt; 打开 &lt;code&gt;Neo4j Browser&lt;/code&gt;：&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://tva3.sinaimg.cn/large/ad5fbf65gy1gm4o605br2j20ow0fkjs1.jpg&#34; alt=&#34;打开数据库&#34;&gt;&lt;/p&gt;
&lt;p&gt;执行命令将 kubernetes resource 导入 Neo4j：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;kubectl graph all -n kube-system -o cypher | cypher-shell -u neo4j -p &amp;lt;your-pass&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;div class=&#34;alert alert-warning&#34; role=&#34;alert&#34;&gt;
&lt;h4 class=&#34;alert-heading&#34;&gt;注意&lt;/h4&gt;
这里的 &lt;code&gt;-u&lt;/code&gt; 需要输入 &lt;code&gt;neo4j&lt;/code&gt; 而不是你创建的数据库名称，&lt;code&gt;Neo4j Browser&lt;/code&gt; 上也有提示：
&lt;img src=&#34;https://tva3.sinaimg.cn/large/ad5fbf65gy1gm4o9rsqtzj21ve0m440w.jpg&#34; alt=&#34;&#34;&gt;
&lt;/div&gt;

&lt;p&gt;之后就可以在 Neo4j 上查看了，输入查询语句：&lt;code&gt;MATCH (n) RETURN n&lt;/code&gt;：&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://tva4.sinaimg.cn/large/ad5fbf65gy1gm4ofe5jiwj22761midzp.jpg&#34; alt=&#34;关系图&#34;&gt;&lt;/p&gt;
&lt;p&gt;这时一个美观的 kubernetes resource 关系图就出现了。&lt;/p&gt;
&lt;h2 id=&#34;结语&#34;&gt;结语&lt;/h2&gt;
&lt;p&gt;kubectl 还有很多好用且有趣的 plugin，后续笔者会介绍如何开发一个 kubectl plugin 并分享更多有趣的 plugin。&lt;/p&gt;

      </description>
    </item>
    
  </channel>
</rss>
